<!DOCTYPE html>
<meta charset="utf-8">
<style>


#header h1 {
  top: 10px;
  left: 10px;
  width: 800px;
  position: absolute;
}

#svgdiv-mx {
  float: left;
  width: 550px;
  height: 850px;
  margin: 10px 20px 10px 20px;
  border-style: solid;
  border-color: #7cafde;
  color: white;
  mix-blend-mode: multiply;
}

#svg-mx {
  align-items: center;
  margin: auto;
  position: relative;
  display: block;
  rotate:
}

#options {
  float:left;
  position: relative;
  margin-left: 600px;
}

.inter-layer {
  stroke: gray;
  stroke-width: 0.5px;
}

.intra-layer {
  stroke: black;
  stroke-width: 1px;
}

</style>


<body>

<div id="header">
  <h1> Multilayer network </h1>
</div>



<div id="svgdiv-mx">
  <svg width="500" height="800" id="svg-mx"></svg>
</div>


<div id="options" width=100 height=200>
  Color nodes by:
  <select id="color-dropdown" title="Node color">
  <option value="name">Name</option>
  </select>

  <button type="button" id="mx-button">Save mx</button>

  Rotate mx:
  <button type="button" id="rotate-button">Rotate</button>



</div>





<!-- Load d3 and other helper scripts -->
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.6.0/d3.min.js"></script>
<script src="d3-save-svg-gh-pages/assets/d3-save-svg.min.js"></script>
<script src="https://unpkg.com/d3-3d/build/d3-3d.min.js"></script>



<!-- begin javascript -->
<script>


// This file originally modified from https://bl.ocks.org/heybignick/3faf257bbbbc7743bb72310d03b86ee8
var svgmx= d3.select("#svg-mx"),
    widthmx = +svgmx.attr("width"),
    heightmx = +svgmx.attr("height");


svgmx.attr("class", "svg_class")


d3.json("data/mx_slide9.json", function(error, graph) {
  if (error) throw error;


  // need to know how many nodes in layer 1
  var nNodes = 17

  // Get coordinates of the first layer of nodes
  x_pos = [];
  y_pos = [];
  for (i = 0; i < nNodes; i++) {
    x_pos.push(graph.nodes[i].x);
    y_pos.push(graph.nodes[i].y)
  }

  // Define the center of our box
  const arrAvg = arr => arr.reduce((a,b) => a + b, 0) / arr.length
  box_center=[arrAvg(x_pos), arrAvg(y_pos)]

  // find the max x or y distance from box_center to any point
  var diffs = [];
  for (i=0; i < nNodes; i++) {
    diffs.push(box_center[0] - graph.nodes[i].x)
    diffs.push(box_center[1] - graph.nodes[i].y)
  }
  box_radius = Math.max(...diffs)

  // Set the box buffer
  var box_buffer = 10;

  // Projection functions

  function project_x(x_coord, alpha, l_v, l_h) {
    x_proj = x_coord*Math.cos(2*Math.PI*(alpha/360)) // cos takes radians
    console.log(x_proj)
    return x_proj
  }

  function project_y(y_coord, alpha, l_v, l_h) {
    y_proj = y_coord*Math.sin(2*Math.PI*(alpha/360)) + l_v;
    return y_proj
  }

  var alpha = 10, l_v = 1, l_h = 0
  // Define box path
  function box_path(box_center, box_radius, box_buffer) {

    // need to project, then scale the projection
        const x1 = x_scale(project_x(box_center[0] - box_radius - box_buffer, alpha, l_v, l_h));
        const y1 = y_scale(project_y(box_center[1] - box_radius - box_buffer, alpha, l_v, l_h)) ;
        const x2 = x_scale(project_x(box_center[0] + box_radius + box_buffer, alpha, l_v, l_h));
        const y2 = y_scale(project_y(box_center[1] + box_radius + box_buffer, alpha, l_v, l_h));

        return `M ${x1},${y2} L ${x2},${y2} L ${x2} ${y1} L ${x1} ${y1} L ${x1} ${y2}`;
      }

// Define necessary functions for nodes


  var node_radius = 5;


  var y_scale = d3.scaleLinear()
    .range([50, heightmx-50])

  y_scale.domain(d3.extent(graph.nodes, function(d) {return project_y(d.y, alpha, d.L2, l_h); }));

  var x_scale = d3.scaleLinear()
    .range([50, widthmx-50])

  x_scale.domain(d3.extent(graph.nodes, function(d) {return d.x; }));

  var node_colormap = d3.scaleOrdinal(d3.schemeCategory20b).domain(d3.extent(graph.nodes, function(d) {return d.L2}));

  d3.select("#color-dropdown").text("first");

  layer_data = Object.getOwnPropertyNames(graph.nodes[0])
  d3.select("#color-dropdown").selectAll("option")
    .data(layer_data)
    .enter()
      .append("option")
        .attr("value", function(d) {return d})
        .text(function(d) {return d});

// functions and info for edges
  function edge_line(d) {
        const source_node = graph.nodes.filter(function(n){return n.id == d.source;})[0]
        const target_node = graph.nodes.filter(function(n){return n.id == d.target;})[0]
        const y1 = y_scale(project_y(source_node.y, alpha, source_node.L2, l_h));
        const x1 = x_scale(project_x(source_node.x, alpha, source_node.L2, l_h));
        const y2 = y_scale(project_y(target_node.y, alpha, target_node.L2, l_h));
        const x2 = x_scale(project_x(target_node.x, alpha, target_node.L2, l_h));
        return `M ${x1},${y1} L ${x2},${y2}`;
      }

  function edge_class(d) {
    // Determine within layer or between layer edges
    node_source_L2 = graph.nodes.filter(function(n){return n.id == d.source;})[0].L2
    node_target_L2 = graph.nodes.filter(function(n){return n.id == d.target;})[0].L2

    if (node_source_L2 == node_target_L2) {
      edge_class_id = "intra-layer"
    } else {
      edge_class_id = "inter-layer"
    }

    return edge_class_id
  }

  var link = svgmx.append("g")
    .selectAll("line")
    .data(graph.links)
    .enter().append("path")
      .attr("d", edge_line)
      .attr("class", edge_class);




  var node = svgmx.append("g")
    .attr("class","nodes")
    .selectAll("g")
    .data(graph.nodes)
    .enter().append("g")


  node.append("circle")
    .attr("r", 10)
    .attr("cx", function(d) {return x_scale(project_x(d.x, alpha, d.L2, l_h))})
    .attr("cy", function(d) {return y_scale(project_y(d.y, alpha, d.L2, l_h))})
    .attr("fill", function(d) {return node_colormap(d.L2)})
    .attr("class", "nodes")
    .attr("stroke", "white")
    .attr("stroke-width", 1)
    .attr("id", function(d) {return d.id})
    .style("isolation","isolate")

  var boxes = svgmx.append("path")
    .attr("d",box_path(box_center, box_radius, box_buffer))
    .attr("stroke", "orange")
    .attr("fill", "none")
    .attr("stroke-width", 5)


// buttons!
  d3.select('#mx-button').on('click', function() {
    var config = {
      filename: 'mx',
    }
    d3_save_svg.save(d3.select('#svg-mx').node(), config);
  });

  d3.select("#rotate-button").on("click", function() {
    d3.select("#svg-mx")
      .attr("transform", "rotate(90)");
  })



});


</script>
